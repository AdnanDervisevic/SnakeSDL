#include "SnakeGame.h"
#include <iostream>

// Creates a new Snake object.
SnakeGame::SnakeGame()
{
	backbuffer = NULL;
	spriteBatch = NULL;
	running = true;
}

// This method is called to run the game.
int SnakeGame::Run()
{
	// Initialize the game.
	if (Initialize() == false)
		return -1;

	SDL_Event event;

	currentTicks = SDL_GetTicks();

	// Run until you close the window.
	while (running)
	{
		// Calculate the delta time since the last run.
		oldTicks = currentTicks;
		currentTicks = SDL_GetTicks();
		float dt = (currentTicks - oldTicks) / 1000.0f;
		
		// Handle the SDL Input
		while (SDL_PollEvent(&event))
			HandleSDLInput(&event);

		// Hand regular input.
		HandleInput();

		// Update and Draw the game.
		Update(dt);
		Draw(dt);

		SDL_Delay(1);
	}

	// Clean up the variables.
	Cleanup();

	return 0;
}

// Here we Initialize our game.
bool SnakeGame::Initialize()
{
	// Initialize the sdl.
	if (SDL_Init(SDL_INIT_EVERYTHING) < 0)
		return false;

	// Create our display surface.
	if ((backbuffer = SDL_SetVideoMode(SCREEN_WIDTH, SCREEN_HEIGHT, SCREEN_BPP, SDL_HWSURFACE | SDL_DOUBLEBUF)) == NULL)
		return false;

	if (TTF_Init() == -1)
		return false;

	// Create the spritebatch.
	spriteBatch = new SpriteBatch(backbuffer);

	// Change our window title
	SDL_WM_SetCaption(WINDOW_TITLE, NULL);

	// Load the player texture.	
	if (player.Initialize(Vector2(200, 0), Texture::Load("Assets/playerTexture.png"), 20, Texture::Load("Assets/playerTexture.png"), 20, Texture::Load("Assets/playerTexture.png"), 20) == false)
		return false;

	// Loads a font using the SpriteFont helper.
	if ((font = SpriteFont::Load("Assets/Lazy.ttf", 28)) == NULL)
		return false;

	// Open the mixer, this is needed to play any audio.
	if (Mix_OpenAudio(AUDIO_RATE, AUDIO_FORMAT, AUDIO_CHANNELS, AUDIO_BUFFERS))
		return false;

	// Load the sound effect.
	if ((proj = SoundEffect::Load("Assets/proj.wav")) == NULL)
		return false;

	// Load the background music, music is static because you can only play one song at the time.
	if ((Music::Load("Assets/background.ogg")) == false)
		return false;

	// Set the volume of the music to 10%
	Music::Volume(10);

	// Start the music and loop it.
	Music::Play(true);

	// Set the volume of the projectile effect.
	proj->Volume(30);

	// Start the sound effect and loop it.
	proj->Play(true);

	if(SDL_NumJoysticks() != 0)
		stick = SDL_JoystickOpen(0);
        
	return true;
}

// Here we handle all the input coming from the SDL library.
void SnakeGame::HandleSDLInput(SDL_Event* event)
{
	// Check if we want to quit
	switch (event->type)
	{
		case SDL_QUIT:
			running = false;
			break;
      
		case SDL_KEYDOWN:
			if (event->key.keysym.sym == SDLK_w)
				player.Turn(DIRECTION_UP);
			else if (event->key.keysym.sym == SDLK_s)
				player.Turn(DIRECTION_DOWN);
			else if (event->key.keysym.sym == SDLK_d)
				player.Turn(DIRECTION_RIGHT);
			else if (event->key.keysym.sym == SDLK_a)
				player.Turn(DIRECTION_LEFT);
			break;
           		
			
		if(stick != NULL)
		{
			case SDL_JOYHATMOTION:
				if(SDL_HAT_UP)
					player.Turn(DIRECTION_UP);
				else if(SDL_HAT_DOWN)
					player.Turn(DIRECTION_DOWN);
				else if(SDL_HAT_LEFT)
					player.Turn(DIRECTION_LEFT);
				else if(SDL_HAT_RIGHT)
					player.Turn(DIRECTION_RIGHT);
				break;
		}
	}
}

// Here we handle all the input not coming from the SDL.
void SnakeGame::HandleInput()
{
}

// Here we update our game.
void SnakeGame::Update(float elapsedGameTime)
{
	player.Update(elapsedGameTime);
}

// Here we draw our game.
void SnakeGame::Draw(float elapsedGameTime)
{
	// Clears the backbuffer.
	SDL_FillRect(backbuffer, NULL, SDL_MapRGB(backbuffer->format, 0, 0, 0));

	// Draws the player.
	player.Draw(elapsedGameTime, this->spriteBatch);
	
	std::string buffert;

	const char *js0,*js1, *js2, *js3, *joysticks;
	js0 = SDL_JoystickName(0);
	joysticks = buffert.c_str();

	if(js0 != NULL)
		spriteBatch->DrawString(js0, Vector2(150,100), font, Color(255,255,255));
	if(js1 != NULL)
		spriteBatch->DrawString(js1, Vector2(350,120), font, Color(255,255,255));
	if(js2 != NULL)	
		spriteBatch->DrawString(js2, Vector2(450,140), font, Color(255,255,255));
	if(js3 != NULL)
		spriteBatch->DrawString(js3, Vector2(550,160), font, Color(255,255,255));
	if(joysticks != NULL)
		spriteBatch->DrawString(joysticks, Vector2(150,180), font, Color(255,255,255));

	// Shows the backbuffer.
	SDL_Flip(backbuffer);
}

// Here we clean up and releases our resources.
void SnakeGame::Cleanup()
{
	// Cleans up the players variables.
	player.Cleanup();

	// Close the font.
	TTF_CloseFont(font);
	font = NULL;

	// Dispose the projectile sound effect.
	proj->Dispose();
	delete proj;

	// Dispose the background music.
	Music::Dispose();

	//CLOSE JOYSTICK
	SDL_JoystickClose(stick);

	// Clean up variables.
	Mix_CloseAudio(); // Close the audio
	delete spriteBatch;
	SDL_FreeSurface(backbuffer);
	SDL_Quit();
}

// The main entry point of the program.
int main(int argc, char* argv[])
{
	// Create the game and run it.
	SnakeGame snake;

	return snake.Run();
}
